<!doctype html>
<html>
	<head>
	</head>
	<body style="margin: 0; background-color: black;">
		<canvas id = "textcanvas" style="border-style: solid; margin: 0; padding: 0; display: block; position: absolute;"></canvas>
		<canvas id = "glcanvas" style="border-style: solid; margin: 0; padding: 0; display: block;">Support for the canvas element is required.</canvas>
		<script src='gl-matrix-min.js'></script>
		<script src='matter.min.js'></script>
		<script src='shaders.js'></script>
		<script src='box.js'></script>
		<script id="vertex_shader" type="x-shader/x-vertex">
			uniform mat4 modelview_matrix;
			uniform mat4 projection_matrix;
			attribute vec3 vertex_coordinates;

			void main(void)
			{ 
				gl_Position = projection_matrix * modelview_matrix * vec4(vertex_coordinates, 1.0);
			}
		</script>
		<script id="fragment_shader" type="x-shader/x-fragment">
			precision mediump float;
			uniform vec4 color;

			void main(void)
			{
				gl_FragColor = color;
			}
		</script>

		<!-- CODE -->

		<script>

		function Radians(angle_in_degrees) 
		{
			return angle_in_degrees * (Math.PI / 180);
		}

		function ProjectText(P, mvp, ctx, text, alignment = "left")
		{
			ctx.textAlign = alignment;
			var p = vec4.clone(P);
			vec4.transformMat4(p, p, mvp);
			p[0] /= p[3];
			p[1] /= p[3];
			var c = vec2.fromValues((p[0] * 0.5 + 0.5) * gl.canvas.width, (p[1] * -0.5 + 0.5) * gl.canvas.height);
			ctx.fillText(text, c[0], c[1]);
		}

		function DrawScene(now)
		{
			var bodies = Composite.allBodies(engine.world);
			var projection_matrix = mat4.create();
			var model_matrix = mat4.create();
			var view_matrix = mat4.create();
			var mvp = mat4.create();
			var p = vec4.create();
			var c = vec2.create();

			now = now / 1000;
			ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
			gl.clearColor(0.1, 0.1, 0.1, 1.0);
			gl.clear(gl.COLOR_BUFFER_BIT);
			gl.viewport(0, 0, canvas.clientWidth, canvas.clientHeight);

			mat4.lookAt(view_matrix, vec3.fromValues(0.0, 0.0, 10.0), vec3.fromValues(0.0, 0.0, 0.0), y_axis);
			mat4.ortho(projection_matrix, -10 * aspect, 10 * aspect, -10, 10, near_plane, far_plane);
			//ProjectText(vec4.fromValues(-1, -0.125, 0, 1), mvp, ctx, "(-1, -0.125)", "center");
			//ProjectText(vec4.fromValues(1, 0.125, 0, 1), mvp, ctx, "(1, 0.125)", "center");

			for (var body_index = 0; body_index < bodies.length; body_index++)
			{
				model_matrix = mat4.create();
				mat4.scale(model_matrix, model_matrix, vec3.fromValues(1, -1, 1));
				var body = bodies[body_index];
				var pos = body.position;
				mat4.translate(model_matrix, model_matrix, vec3.fromValues(pos.x, -pos.y, 0));
				mat4.rotate(model_matrix, model_matrix, body.angle, z_axis);
				box.Draw(model_matrix, view_matrix, projection_matrix);
			}
			
			requestAnimationFrame(DrawScene);
		}

		var canvas = document.getElementById('glcanvas');
		var textCanvas = document.getElementById("textcanvas");
		var gl = canvas.getContext('webgl');
		var ctx = textCanvas.getContext("2d");
		canvas.width = textCanvas.width = window.innerWidth - 10;
		canvas.height = textCanvas.height = window.innerHeight - 10;
		var aspect = canvas.width / canvas.height;

		var x_axis = vec3.fromValues(1, 0, 0);
		var y_axis = vec3.fromValues(0, 1, 0);
		var z_axis = vec3.fromValues(0, 0, 1);
		var near_plane = 1;
		var far_plane = 100;
		var Engine = Matter.Engine;
		var Bodies = Matter.Bodies;
		var Body = Matter.Body;
		var World = Matter.World;
		var Vector = Matter.Vector;
		var Composite = Matter.Composite;
		var engine = Engine.create();
		engine.world.gravity.y *= -1;
		engine.world.gravity.scale = 0.00001;

		var box = new Box();
		box.Initialize(2, 0.5);
		var brick = Bodies.rectangle(-10, 4, 2, 0.5);
		brick.restitution = 1;
		brick.friction = 0;
		//Body.setAngularVelocity(brick, 0.5);
		Body.setVelocity(brick, Vector.create(0.2, 0.2));
		var ground = Bodies.rectangle(7, -8, 2, 0.5, {isStatic: true});
		ground.restitution = 1;
		ground.friction = 0;
		ground.frictionStatic = 0;
		World.add(engine.world, [ground, brick]);
		Engine.run(engine);

		ctx.font = "32px Helvetica";
		ctx.textBaseline = "middle";
		ctx.fillStyle = "#ffffff";

		requestAnimationFrame(DrawScene);

		</script>
	</body>
</html>
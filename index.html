<!doctype html>
<html>
	<head>
	</head>
	<body style="margin: 0; background-color: black;">
		<canvas id = "glcanvas" style="border-style: solid; margin: 0; padding: 0; z-index: 20; position: absolute;">Support for the canvas element is required.</canvas>
		<canvas id = "textcanvas" style="border-style: solid; margin: 0; padding: 0; top: 0px; left: 0px; z-index: 10; position: absolute;"></canvas>
		<script src='gl-matrix-min.js'></script>
		<script src='matter.min.js'></script>
		<script src='shaders.js'></script>
		<script src='box.js'></script>
		<script src='disc.js'></script>

		<script id="vertex_shader" type="x-shader/x-vertex">
			uniform mat4 modelview_matrix;
			uniform mat4 projection_matrix;
			attribute vec3 vertex_coordinates;

			void main(void)
			{ 
				gl_Position = projection_matrix * modelview_matrix * vec4(vertex_coordinates, 1.0);
			}
		</script>
		<script id="fragment_shader" type="x-shader/x-fragment">
			precision mediump float;
			uniform vec4 color;

			void main(void)
			{
				gl_FragColor = color;
			}
		</script>

		<!-- CODE -->

		<script>

		function Radians(angle_in_degrees) 
		{
			return angle_in_degrees * (Math.PI / 180);
		}

		function PushVertex(a, v)
		{
			switch (v.length)
			{
				case 2:
					a.push(v[0], v[1]);
					break;

				case 3:
					a.push(v[0], v[1], v[2]);
					break;

				case 4:
					a.push(v[0], v[1], v[2], v[3]);
					break;
			}
		}

		function ProjectText(P, mvp, ctx, text, alignment = "left")
		{
			ctx.textAlign = alignment;
			var p = vec4.clone(P);
			vec4.transformMat4(p, p, mvp);
			p[0] /= p[3];
			p[1] /= p[3];
			var c = vec2.fromValues((p[0] * 0.5 + 0.5) * gl.canvas.width, (p[1] * -0.5 + 0.5) * gl.canvas.height);
			ctx.fillText(text, c[0], c[1]);
		}

		function DrawScene(now)
		{
			var bodies = Composite.allBodies(engine.world);
			var projection_matrix = mat4.create();
			var model_matrix = mat4.create();
			var view_matrix = mat4.create();
			var mvp = mat4.create();
			var p = vec4.create();
			var c = vec2.create();

			now = now / 1000;
			//ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
			gl.clearColor(0.1, 0.1, 0.1, 1.0);
			gl.clear(gl.COLOR_BUFFER_BIT);
			gl.viewport(0, 0, canvas.clientWidth, canvas.clientHeight);

			mat4.lookAt(view_matrix, vec3.fromValues(0.0, 0.0, 10.0), vec3.fromValues(0.0, 0.0, 0.0), y_axis);
			mat4.ortho(projection_matrix, 0, canvas.width, 0, canvas.height, near_plane, far_plane);

			for (var body_index = 0; body_index < bodies.length; body_index++)
			{
				model_matrix = mat4.create();
				mat4.scale(model_matrix, model_matrix, vec3.fromValues(1, -1, 1));
				var body = bodies[body_index];
				var pos = body.position;
				if (pos.y < -150) 
				{
					Body.setPosition(bodies[body_index], Vector.create(400, 1000));
					Body.setVelocity(bodies[body_index], Vector.create(0, 0));
					Body.setAngularVelocity(bodies[body_index], 0);
				}
				mat4.translate(model_matrix, model_matrix, vec3.fromValues(pos.x, -pos.y, 0));
				mat4.rotate(model_matrix, model_matrix, -body.angle, z_axis);
				if (body.label == 'rect') {
					boxes[body.size_id].Draw(model_matrix, view_matrix, projection_matrix, vec4.fromValues(1, 0, 0, 1), vec4.fromValues(0.5,0,0,1));
				}
				else if (body.label == 'ball')
				{
					solid_disc.Draw(model_matrix, view_matrix, projection_matrix, vec4.fromValues(0.5,0,0,1));
					disc_rim.Draw(model_matrix, view_matrix, projection_matrix, vec4.fromValues(1,0,0,1));
				}
			}
			
			requestAnimationFrame(DrawScene);
		}

		function InitBox(box_size)
		{
			var box = new Box();
			box.Initialize(box_size[0], box_size[1]);
			boxes.push(box);
		}

		var canvas = document.getElementById('glcanvas');
		var textCanvas = document.getElementById("textcanvas");
		var gl = canvas.getContext('webgl');
		var ctx = textCanvas.getContext("2d");
		canvas.width = textCanvas.width = window.innerWidth - 10;
		canvas.height = textCanvas.height = window.innerHeight - 10;
		var aspect = canvas.width / canvas.height;

		var x_axis = vec3.fromValues(1, 0, 0);
		var y_axis = vec3.fromValues(0, 1, 0);
		var z_axis = vec3.fromValues(0, 0, 1);
		var ball_radius = 50;
		var near_plane = 1;
		var far_plane = 100;
		var Render = Matter.Render;
		var Engine = Matter.Engine;
		var Bodies = Matter.Bodies;
		var Body = Matter.Body;
		var World = Matter.World;
		var Vector = Matter.Vector;
		var Composite = Matter.Composite;
		var engine = Engine.create();
		engine.world.gravity.y *= -1;

		var render = Render.create({
				element: document.body,
				engine: engine,
				canvas: textCanvas,
				options: {
					width: textCanvas.width,
					height: textCanvas.height,
					showAngleIndicator: true
				}
			});

		var box_sizes = [ [300, 50], [600, 50], [900, 50] ];
		var boxes = [ ];
		box_sizes.forEach(InitBox);
		var solid_disc = new Disc();
		var disc_rim = new Disc();
		solid_disc.Initialize(ball_radius, 0.0, vec3.fromValues(0,0,0), vec3.fromValues(0,0,0), 0, 360, 32, 1)
		disc_rim.Initialize(ball_radius, ball_radius - 5, vec3.fromValues(0,0,0), vec3.fromValues(0,0,0), 0, 360, 32, 1);

		var ground3 = Bodies.rectangle(1700, 830, boxes[1].width, boxes[1].height, {isStatic: true});
		ground3.restitution = 1;
		ground3.size_id = 1;
		ground3.label = 'rect';
		ground3.friction = 0;
		Body.rotate(ground3, Radians(90));

		var ground2 = Bodies.rectangle(1400, 400, boxes[1].width, boxes[1].height, {isStatic: true});
		ground2.restitution = 1;
		ground2.size_id = 1;
		ground2.label = 'rect';
		ground2.friction = 0;
		Body.rotate(ground2, 0.4);
		
		var ground1 = Bodies.rectangle(450, 250, boxes[2].width, boxes[2].height, {isStatic: true});
		ground1.label = 'rect';
		ground1.restitution = 1;
		ground1.size_id = 2;
		ground1.friction = 0;
		Body.rotate(ground1, -0.35);

		var ball = Bodies.circle(200, 1000, ball_radius);
		ball.restitution = 1;
		ball.frictionAir = 0;
		ball.label = 'ball';
		ball.friction = 0;

		World.add(engine.world, [ ground2, ground1, ground3, ball ]);
		Engine.run(engine);
		//Render.run(render);

		ctx.font = "32px Helvetica";
		ctx.textBaseline = "middle";
		ctx.fillStyle = "#ffffff";

		requestAnimationFrame(DrawScene);

		</script>
	</body>
</html>